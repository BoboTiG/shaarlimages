function linearPartitionFitPics(n,e){e.border=e.border||0,e.spacing=e.spacing||0;var t,r,i,a,u,o,l,c,s=0,f=0,p=0,d=[],h=[],m=function(n,e){var t,r,i,a,u=n.length,o=[],l=[],c=[],s=[],f={};for(t=0;u>t;t+=1){for(o=[],r=0;e>r;r+=1)o.push(0);l.push(o)}for(t=0;u-1>t;t+=1){for(o=[],r=0;e-1>r;r+=1)o.push(0);c.push(o)}for(t=0;u>t;t+=1)l[t][0]=n[t]+(t?l[t-1][0]:0);for(t=0;e>t;t+=1)l[0][t]=n[0];for(t=1;u>t;t+=1)for(r=1;e>r;r+=1){for(s=[],i=0;t>i;i+=1)s.push([Math.max(l[i][r-1],l[t][0]-l[i][0]),i]);for(f={computed:1/0,value:1/0},i=0,a=s.length;a>i;i+=1)s[i][0]<f.computed&&(f={value:s[i],computed:s[i][0]});l[t][r]=f.value[0],c[t-1][r-1]=f.value[1]}return[l,c]},v=function(n,e){var t,r,i,a=n.length-1,u=[],o=[],l=[];if(1>e)return o;if(e>a){for(t=0;a>=t;t+=1)o.push([n[t]]);return o}for(i=m(n,e),r=i[1],e-=2;e>=0;){for(l=[],t=r[a-1][e]+1;a>=t;t+=1)l.push(n[t]);l=[l],u=l.concat(u),a=r[a-1][e],e-=1}for(t=0;a>=t;t+=1)o.push(n[t]);return o=[o],o.concat(u)};for(t=0,i=n.length;i>t;t+=1)n[t].aspectRatio=n[t].width/n[t].height,f+=n[t].aspectRatio*e.preferedImageHeight;if(u=Math.round(f/e.containerWidth),1>=u)for(t=0,i=n.length;i>t;t+=1)n[t].width=parseInt(e.preferedImageHeight*n[t].aspectRatio,10),n[t].height=e.preferedImageHeight;else{for(t=0,i=n.length;i>t;t+=1)d.push(parseInt(100*n[t].aspectRatio,10));a=v(d,u);for(t in a){for(o=a[t],l=e.containerWidth,p=0,h=[],i=o.length,e.spacing&&(l-=e.spacing*(i-1)),r=0;i>r;r+=1)h.push(n[s]),s+=1;for(r=0,i=h.length;i>r;r+=1)p+=h[r].aspectRatio;for(r=0;i>r;r+=1)c=h[r],c.width=parseInt(l/p*c.aspectRatio,10),c.height=parseInt(l/p,10),r===i-1&&(c.last=!0)}}return n}function ambilight_effect(){var n,e=document.getElementsByTagName("img")[0],t=document.createElement("canvas"),r=t.getContext("2d"),i="assets/img/mask.png",a=new Image,u=150,o=function(n,e,t){var r,i=[0,0,0],a=(t-e)/4;for(r=e;t>=r;r+=4)i[0]+=n[r],i[1]+=n[r+1],i[2]+=n[r+2];return i[0]=Math.round(i[0]/a),i[1]=Math.round(i[1]/a),i[2]=Math.round(i[2]/a),i},l=function(n,e,t){var r,i,a=n.width,u=n.height,l=5,c=Math.ceil(u/l),s=4*t*c,f=[],p=e.getImageData(0,0,t,u),d=p.data.length;for(r=0;l>r;r+=1)i=r*a*t,f.push(o(p.data,r*s,Math.min((r+1)*s,d-1)));return f},c=function(n,t){var r,i,a,u,o=n,c=document.createElement("canvas"),s=c.getContext("2d");for(c.style.position="absolute",c.style.top="0",c.style.zIndex="-2",c.style.width="100%",c.style.height="100%",c.width=n,c.height=e.height,t&&(o=e.width-n),s.drawImage(e,o,0,c.width,c.height,0,0,c.width,c.height),a=l(c,s,n),u=s.createLinearGradient(0,0,0,c.height),r=0,i=a.length;i>r;r+=1)u.addColorStop(r/i,"rgb("+a[r]+")");return s.fillStyle=u,s.fillRect(0,0,c.width,c.height),c};n=c(u,!1),n.style.left="0",document.body.appendChild(n),t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.zIndex="-1",t.style.width="100%",t.style.height="100%",a.src=i,t.width=a.width,t.height=a.height,r.drawImage(a,0,0,t.width,t.height),document.body.appendChild(t)}function parse_query_string(){var n=window.location.search,e={};return n.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(n,t,r,i){e[t]=i}),e}function add_event(n,e,t){return n.attachEvent?n.attachEvent("on"+e,t):n.addEventListener(e,t,!1)}function parse_date(n){var e=new Date(1e3*n),t=e.getFullYear().toString(),r=(e.getMonth()+1).toString(),i=e.getDate().toString();return 1===r.length&&(r="0"+r),1===i.length&&(i="0"+i),t+r+i}function store_cookie(){var n=new Date,e=new Date(n.getTime()+31536e6),t="prefs="+JSON.stringify(galinear_prefs)+";expires="+e+";";navigator.cookieEnabled&&(document.cookie=t)}function read_cookie(){var n,e,t;if(navigator.cookieEnabled&&document.cookie.length>0){t=document.cookie.split("; ");for(n in t)if("prefs"==t[n].split("=")[0]){e=JSON.parse(t[n].split("=")[1]);for(n in e)e[n]=parseInt(e[n],10),isNaN(e[n])&&(e[n]=0);return e}}return galinear_prefs}if(!galinear_opt)var galinear_opt={gallery_url:"/",img_folder:"images/",thumb_folder:"images/thumbs/",txt_no_img:"Aucune image ☹",txt_older:"◄ Vieilleries",txt_newer:"Nouveautés ►",txt_home:"Retour à la galerie",txt_permalink:"Lien source",txt_source:"Image originale",txt_pref_toolbar:"La barre d'outils est affichée",txt_pref_toolbar_no:"La barre d'outils n'est pas affichée",txt_pref_show_nsfw:"Les images sensibles ne sont pas filtrées",txt_pref_show_nsfw_no:"Les images sensibles sont filtrées",touch_support:"ontouchend"in document};if(!galinear_prefs)var galinear_prefs={per_page:20,lines:3,show_nsfw:0,toolbar:1};var params=parse_query_string();if(params.per_page&&(galinear_prefs.per_page=parseInt(params.per_page,10)),params.lines&&(galinear_prefs.lines=parseInt(params.lines,10)),params.show_nsfw&&(galinear_prefs.show_nsfw=parseInt(params.show_nsfw,10)),params.toolbar&&(galinear_prefs.toolbar=parseInt(params.toolbar,10)),galinear_prefs=read_cookie(),galinear_prefs.per_page<10&&(galinear_prefs.per_page=10),galinear_prefs.lines<2&&(galinear_prefs.lines=2),1!==galinear_prefs.show_nsfw&&(galinear_prefs.show_nsfw=0),1!==galinear_prefs.toolbar&&(galinear_prefs.toolbar=0),params.i&&gallery.length>0){var figure,img,title,toolbar,home,permalink,source,previous,next,start=0,curr_prev_next=function(n){var e,t=gallery.length,r=!1,i=!1,a=!1;for(e=0;t>e;e+=1)if(gallery[e].k===n){r=gallery[e],e>0&&(i=gallery[e-1]),t-1>e&&(a=gallery[e+1]);break}return{current:r,previous:i,next:a}},curr_prev_next_img=curr_prev_next(params.i),image=curr_prev_next_img.current;image===!1?document.write("<p>"+galinear_opt.txt_no_img+"</p>"):(title="",image.n&&(title+="[ ☂ NSFW ] "),title+=image.s+" - "+document.title,document.title=title,img=document.createElement("img"),img.src=galinear_opt.img_folder+image.s,figure=document.createElement("figure"),figure.className="image-container-alone",figure.appendChild(img),document.body.appendChild(figure),galinear_opt.touch_support?(add_event(document,"touchstart",function(n){start=n.targetTouches[0].clientX},!1),add_event(document,"touchmove",function(n){n.preventDefault(),start-n.targetTouches[0].clientX<0?curr_prev_next_img.previous!==!1&&(document.location="?i="+curr_prev_next_img.previous.k):curr_prev_next_img.next!==!1&&(document.location="?i="+curr_prev_next_img.next.k)},!1)):(curr_prev_next_img.previous!==!1&&(previous=document.createElement("a"),previous.className="image-container-previous",previous.href="?i="+curr_prev_next_img.previous.k,previous.text="⍃",document.body.appendChild(previous)),curr_prev_next_img.next!==!1&&(next=document.createElement("a"),next.className="image-container-next",next.href="?i="+curr_prev_next_img.next.k,next.text="⍄",document.body.appendChild(next)),document.onkeydown=function(n){switch(n=n||window.event,n.which||n.keyCode){case 37:curr_prev_next_img.previous!==!1&&(document.location="?i="+curr_prev_next_img.previous.k);break;case 39:curr_prev_next_img.next!==!1&&(document.location="?i="+curr_prev_next_img.next.k)}}),galinear_prefs.toolbar&&(home=document.createElement("a"),home.className="home",home.href=galinear_opt.gallery_url,home.title=galinear_opt.txt_home,permalink=document.createElement("a"),permalink.className="permalink",image.g&&(permalink.href=image.g),permalink.title=galinear_opt.txt_permalink,source=document.createElement("a"),source.className="source",source.href=img.src,source.title=galinear_opt.txt_source,toolbar=document.createElement("div"),toolbar.className="image-container-alone-toolbar",toolbar.appendChild(home),toolbar.appendChild(permalink),toolbar.appendChild(source),document.body.appendChild(toolbar))),window.onload=ambilight_effect}else{var gallery_images=[],linear_me=function(){if("undefined"==typeof gallery)return document.write("<p>"+galinear_opt.txt_no_img+"</p>"),void 0;var n,e,t,r,i,a,u,o,l="",c=0,s=1,f=0,p=gallery.length,d=document.getElementById("image-container"),h=Math.ceil(p/galinear_prefs.per_page);if(params.p&&!params.d&&(s=parseInt(params.p,10),1>s&&(s=1),s>h&&(s=h),f=(s-1)*galinear_prefs.per_page),0===gallery_images.length){if(params.d){for(o=[],n=0;p>n;n+=1)parse_date(gallery[n].d)===params.d&&o.push(gallery[n]);gallery=o,p=gallery.length}for(n=f;p>n&&c<galinear_prefs.per_page;n+=1,c+=1)i=document.createElement("img"),r=document.createElement("a"),r.href="?i="+gallery[n].k,r.style.width=gallery[n].w+"px",r.style.height=gallery[n].h+"px",r.appendChild(i),gallery[n].n&&!galinear_prefs.show_nsfw&&(r.className="nsfw"),d.appendChild(r),gallery_images.push({originalImage:i,width:gallery[n].w,height:gallery[n].h,nsfw:gallery[n].n})}if(0===p)return document.write("<p>"+galinear_opt.txt_no_img+"</p>"),void 0;for(u=linearPartitionFitPics(gallery_images,{containerWidth:document.documentElement.clientWidth-16,preferedImageHeight:parseInt(document.documentElement.clientHeight/galinear_prefs.lines,10),spacing:4}),t=d.getElementsByTagName("a"),n=0,p=gallery_images.length;p>n;n+=1)e=gallery_images[n],t[n].style.width=u[n].width+"px",t[n].style.height=u[n].height+"px",e.originalImage.width=u[n].width,e.originalImage.height=u[n].height,e.originalImage.src=galinear_opt.thumb_folder+gallery[f+n].s,add_event(e.originalImage,"load",function(n){n.className="show-off"}(e.originalImage)),e.last||(t[n].style.marginRight="4px"),gallery_images[n].nsfw&&!galinear_prefs.show_nsfw&&u[n].width<95&&(t[n].style.backgroundSize="contain");if(t[p-1].style.marginBottom="8px",!params.d&&h>1&&(a=document.createElement("footer"),l="",s>0&&h>s&&(l+='<a href="?p='+(s+1)+'">'+galinear_opt.txt_older+"</a> &nbsp; "),l+=" &nbsp; page "+s+"/"+h+" &nbsp; ",s>1&&(l+=' &nbsp; <a href="?p='+(s-1)+'">'+galinear_opt.txt_newer+"</a>"),a.innerHTML=l,document.body.appendChild(a),navigator.cookieEnabled)){var m=document.createElement("div"),v=document.createElement("a"),g=document.createElement("a");l=galinear_prefs.toolbar?galinear_opt.txt_pref_toolbar:galinear_opt.txt_pref_toolbar_no,v.text="♆",v.title=l,v.className=galinear_prefs.toolbar?"enabled":"disabled",add_event(v,"click",function(){galinear_prefs.toolbar=!galinear_prefs.toolbar+0,v.className=galinear_prefs.toolbar?"enabled":"disabled",l=galinear_prefs.toolbar?galinear_opt.txt_pref_toolbar:galinear_opt.txt_pref_toolbar_no,v.title=l,store_cookie()}),m.appendChild(v),l=galinear_prefs.show_nsfw?galinear_opt.txt_pref_show_nsfw:galinear_opt.txt_pref_show_nsfw_no,g.text="☂",g.title=l,g.className=galinear_prefs.show_nsfw?"disabled":"enabled",add_event(g,"click",function(){galinear_prefs.show_nsfw=!galinear_prefs.show_nsfw+0,g.className=galinear_prefs.show_nsfw?"disabled":"enabled",l=galinear_prefs.show_nsfw?galinear_opt.txt_pref_show_nsfw_no:galinear_opt.txt_pref_show_nsfw,g.title=l,store_cookie(),location.reload(!0)}),m.appendChild(g),m.className="prefs",d.appendChild(m)}galinear_opt.touch_support||(document.onkeydown=function(n){switch(n=n||window.event,n.which||n.keyCode){case 37:s>0&&h>s&&(document.location="?p="+(s+1));break;case 39:s>1&&(document.location="?p="+(s-1))}})};window.onload=linear_me}
